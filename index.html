<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการคลังสื่อการสอน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:hover { transform: scale(1.02); }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-500 p-3 rounded-lg">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">ระบบจัดการคลังสื่อการสอน</h1>
                        <p class="text-gray-600 text-sm">จัดเก็บและค้นหาสื่อการสอนอย่างมีประสิทธิภาพ</p>
                    </div>
                </div>
                <button id="addMediaBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 shadow-lg hover-scale">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    เพิ่มสื่อใหม่
                </button>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Search and Filter Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ค้นหาสื่อ</label>
                    <input type="text" id="searchInput" placeholder="ค้นหาชื่อสื่อ..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">วิชา</label>
                    <input type="text" id="subjectFilter" placeholder="ค้นหาตามวิชา..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ระดับชั้น</label>
                    <select id="gradeFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">ทุกระดับ</option>
                        <option value="ม.1">ม.1</option>
                        <option value="ม.2">ม.2</option>
                        <option value="ม.3">ม.3</option>
                        <option value="ม.4">ม.4</option>
                        <option value="ม.5">ม.5</option>
                        <option value="ม.6">ม.6</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทสื่อ</label>
                    <select id="typeFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">ทุกประเภท</option>
                        <option value="วิดีโอ">วิดีโอ</option>
                        <option value="เอกสาร">เอกสาร</option>
                        <option value="รูปภาพ">รูปภาพ</option>
                        <option value="เสียง">เสียง</option>
                        <option value="เกม">เกม</option>
                        <option value="แบบทดสอบ">แบบทดสอบ</option>
                        <option value="เว็บไซต์">เว็บไซต์</option>
                        <option value="มัลติมีเดีย">มัลติมีเดีย</option>
                    </select>
                </div>
            </div>
            
            <!-- Debug Info -->
            <div id="debugInfo" class="mt-4 p-3 bg-gray-100 rounded-lg text-sm text-gray-600" style="display: none;">
                <strong>Debug Info:</strong> <span id="debugText">พร้อมใช้งาน</span>
            </div>
        </div>

        <!-- Media List -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden fade-in">
            <div class="px-6 py-4 bg-gray-50 border-b">
                <h2 class="text-xl font-semibold text-gray-800">รายการสื่อการสอน</h2>
                <p class="text-gray-600 text-sm mt-1">จำนวนสื่อทั้งหมด: <span id="totalCount" class="font-medium">0</span> รายการ</p>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รหัสสื่อ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่บันทึก</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วิชา</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ระดับชั้น</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภทสื่อ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อสื่อ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การจัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="mediaTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Media Modal -->
    <div id="mediaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-screen overflow-y-auto">
            <div class="px-6 py-4 border-b bg-gray-50">
                <h3 id="modalTitle" class="text-xl font-semibold text-gray-800">เพิ่มสื่อการสอนใหม่</h3>
            </div>
            
            <form id="mediaForm" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">วิชา *</label>
                        <input type="text" id="modalSubject" required placeholder="ระบุชื่อวิชา" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ระดับชั้น *</label>
                        <select id="modalGrade" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">เลือกระดับชั้น</option>
                            <option value="ม.1">ม.1</option>
                            <option value="ม.2">ม.2</option>
                            <option value="ม.3">ม.3</option>
                            <option value="ม.4">ม.4</option>
                            <option value="ม.5">ม.5</option>
                            <option value="ม.6">ม.6</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทสื่อ *</label>
                    <select id="modalType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">เลือกประเภทสื่อ</option>
                        <option value="วิดีโอ">วิดีโอ</option>
                        <option value="เอกสาร">เอกสาร</option>
                        <option value="รูปภาพ">รูปภาพ</option>
                        <option value="เสียง">เสียง</option>
                        <option value="เกม">เกม</option>
                        <option value="แบบทดสอบ">แบบทดสอบ</option>
                        <option value="เว็บไซต์">เว็บไซต์</option>
                        <option value="มัลติมีเดีย">มัลติมีเดีย</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อสื่อ *</label>
                    <input type="text" id="modalMediaTitle" required placeholder="ระบุชื่อสื่อการสอน" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ลิงก์สื่อ *</label>
                    <input type="url" id="modalMediaLink" required placeholder="https://example.com/media" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ลิงก์สำหรับแก้ไข</label>
                    <input type="url" id="modalEditLink" placeholder="https://example.com/edit (ไม่บังคับ)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" id="cancelBtn" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200">ยกเลิก</button>
                    <button type="submit" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="p-6">
                <div class="flex items-center justify-center w-12 h-12 mx-auto mb-4 bg-red-100 rounded-full">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 text-center mb-2">ยืนยันการลบข้อมูล</h3>
                <p class="text-gray-600 text-center mb-6">คุณต้องการลบสื่อการสอนนี้หรือไม่?<br>การดำเนินการนี้ไม่สามารถยกเลิกได้</p>
                <div id="deleteMediaInfo" class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="text-sm">
                        <div class="font-medium text-gray-900" id="deleteMediaTitle">ชื่อสื่อ</div>
                        <div class="text-gray-600 mt-1">
                            <span id="deleteMediaSubject">วิชา</span> • 
                            <span id="deleteMediaGrade">ระดับชั้น</span> • 
                            <span id="deleteMediaType">ประเภท</span>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button id="cancelDeleteBtn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200 font-medium">
                        ยกเลิก
                    </button>
                    <button id="confirmDeleteBtn" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200 font-medium">
                        ลบข้อมูล
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="fixed top-4 right-4 z-50"></div>

    <script>
        // Google Apps Script URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwddMIyglM3oogsMf0TQA7bDwpQJoh_1BjS7RUIVNcPZZZ3KLh6VR5wuDYfysh3M0GF/exec';
        
        let mediaData = [];
        let currentEditId = null;
        let currentDeleteId = null;

        // DOM Elements
        const addMediaBtn = document.getElementById('addMediaBtn');
        const mediaModal = document.getElementById('mediaModal');
        const mediaForm = document.getElementById('mediaForm');
        const cancelBtn = document.getElementById('cancelBtn');
        const deleteModal = document.getElementById('deleteModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const searchInput = document.getElementById('searchInput');
        const subjectFilter = document.getElementById('subjectFilter');
        const gradeFilter = document.getElementById('gradeFilter');
        const typeFilter = document.getElementById('typeFilter');
        const mediaTableBody = document.getElementById('mediaTableBody');
        const totalCount = document.getElementById('totalCount');
        const debugInfo = document.getElementById('debugInfo');
        const debugText = document.getElementById('debugText');

        // Event Listeners
        addMediaBtn.addEventListener('click', openAddModal);
        cancelBtn.addEventListener('click', closeModal);
        mediaForm.addEventListener('submit', handleSubmit);
        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        confirmDeleteBtn.addEventListener('click', confirmDelete);
        
        // เพิ่ม event listeners สำหรับการค้นหา - ใช้ฟังก์ชัน filterData โดยตรง
        searchInput.addEventListener('input', filterData);
        searchInput.addEventListener('keyup', filterData);
        
        subjectFilter.addEventListener('input', filterData);
        subjectFilter.addEventListener('keyup', filterData);
        
        gradeFilter.addEventListener('change', filterData);
        typeFilter.addEventListener('change', filterData);

        // Close modal when clicking outside
        mediaModal.addEventListener('click', (e) => {
            if (e.target === mediaModal) closeModal();
        });

        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) closeDeleteModal();
        });

        function updateDebugInfo(message) {
            debugText.textContent = message;
            debugInfo.style.display = 'block';
            
            // ซ่อน debug info หลังจาก 2 วินาที
            setTimeout(() => {
                debugInfo.style.display = 'none';
            }, 2000);
        }

        function openAddModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'เพิ่มสื่อการสอนใหม่';
            mediaForm.reset();
            mediaModal.classList.remove('hidden');
            mediaModal.classList.add('flex');
        }

        function openEditModal(id) {
            const media = mediaData.find(m => m.id === id);
            if (!media) return;

            currentEditId = id;
            document.getElementById('modalTitle').textContent = 'แก้ไขสื่อการสอน';
            
            document.getElementById('modalSubject').value = media.subject;
            document.getElementById('modalGrade').value = media.grade;
            document.getElementById('modalType').value = media.type;
            document.getElementById('modalMediaTitle').value = media.title;
            document.getElementById('modalMediaLink').value = media.mediaLink;
            document.getElementById('modalEditLink').value = media.editLink || '';
            
            mediaModal.classList.remove('hidden');
            mediaModal.classList.add('flex');
        }

        function closeModal() {
            mediaModal.classList.add('hidden');
            mediaModal.classList.remove('flex');
            currentEditId = null;
        }

        function openDeleteModal(id) {
            const media = mediaData.find(m => m.id === id);
            if (!media) return;

            currentDeleteId = id;
            
            // แสดงข้อมูลสื่อที่จะลบ
            document.getElementById('deleteMediaTitle').textContent = media.title || 'ไม่ระบุชื่อ';
            document.getElementById('deleteMediaSubject').textContent = media.subject || 'ไม่ระบุวิชา';
            document.getElementById('deleteMediaGrade').textContent = media.grade || 'ไม่ระบุระดับ';
            document.getElementById('deleteMediaType').textContent = media.type || 'ไม่ระบุประเภท';
            
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
        }

        function closeDeleteModal() {
            deleteModal.classList.add('hidden');
            deleteModal.classList.remove('flex');
            currentDeleteId = null;
        }

        async function confirmDelete() {
            if (!currentDeleteId) return;
            
            try {
                showMessage('กำลังลบข้อมูล...', 'info');
                console.log('🗑️ Deleting media with ID:', currentDeleteId);
                
                // ถ้าเป็นข้อมูลทดสอบ ให้ลบจาก array โดยตรง
                if (currentDeleteId.startsWith('TEST')) {
                    console.log('🧪 Deleting test data locally');
                    const originalLength = mediaData.length;
                    mediaData = mediaData.filter(media => media.id !== currentDeleteId);
                    
                    if (mediaData.length < originalLength) {
                        console.log('✅ Test data deleted successfully');
                        showMessage('ลบสื่อเรียบร้อยแล้ว', 'success');
                        closeDeleteModal();
                        renderTable(); // อัพเดทตารางทันที
                    } else {
                        console.log('❌ Test data not found');
                        showMessage('ไม่พบข้อมูลที่ต้องการลบ', 'error');
                    }
                    return;
                }
                
                // สำหรับข้อมูลจริงจาก Google Sheets
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({ action: 'deleteMedia', id: currentDeleteId })
                });
                
                console.log('Delete response status:', response.status);
                const responseText = await response.text();
                console.log('Delete response text:', responseText);
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error in delete:', parseError);
                    showMessage('ข้อมูลตอบกลับไม่ถูกต้อง', 'error');
                    return;
                }
                
                if (result.success) {
                    showMessage('ลบสื่อเรียบร้อยแล้ว', 'success');
                    closeDeleteModal();
                    await loadData();
                } else {
                    showMessage('เกิดข้อผิดพลาด: ' + (result.error || 'ไม่ทราบสาเหตุ'), 'error');
                }
            } catch (error) {
                console.error('Error in confirmDelete:', error);
                showMessage('เกิดข้อผิดพลาดในการลบข้อมูล: ' + error.message, 'error');
            }
        }

        // Load data from Google Sheets
        async function loadData() {
            try {
                showMessage('กำลังโหลดข้อมูล...', 'info');
                console.log('Fetching data from:', SCRIPT_URL);
                
                const response = await fetch(`${SCRIPT_URL}?action=getAllMedia`);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    showMessage('ข้อมูลที่ได้รับไม่ถูกต้อง กรุณาตรวจสอบ Google Apps Script', 'error');
                    return;
                }
                
                console.log('Parsed data:', data);
                
                if (data && Array.isArray(data)) {
                    mediaData = data;
                    console.log('📊 Loaded media data:', mediaData.length, 'items');
                    renderTable();
                    showMessage('โหลดข้อมูลเรียบร้อยแล้ว', 'success');
                } else if (data && data.error) {
                    showMessage('ข้อผิดพลาดจาก Google Sheets: ' + data.error, 'error');
                } else {
                    console.log('Data structure:', typeof data, data);
                    mediaData = [];
                    renderTable();
                    showMessage('ยังไม่มีข้อมูลสื่อการสอน', 'info');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showMessage(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const formData = {
                subject: document.getElementById('modalSubject').value,
                grade: document.getElementById('modalGrade').value,
                type: document.getElementById('modalType').value,
                title: document.getElementById('modalMediaTitle').value,
                mediaLink: document.getElementById('modalMediaLink').value,
                editLink: document.getElementById('modalEditLink').value
            };

            try {
                if (currentEditId) {
                    // Edit existing media
                    showMessage('กำลังแก้ไขข้อมูล...', 'info');
                    console.log('Updating media with ID:', currentEditId, 'Data:', formData);
                    
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify({ action: 'updateMedia', id: currentEditId, data: formData })
                    });
                    
                    console.log('Update response status:', response.status);
                    const responseText = await response.text();
                    console.log('Update response text:', responseText);
                    
                    const result = JSON.parse(responseText);
                    
                    if (result.success) {
                        showMessage('แก้ไขข้อมูลสื่อเรียบร้อยแล้ว', 'success');
                        closeModal(); // ปิด modal ก่อน
                        await loadData();
                    } else {
                        showMessage('เกิดข้อผิดพลาด: ' + result.error, 'error');
                    }
                } else {
                    // Add new media
                    showMessage('กำลังเพิ่มข้อมูล...', 'info');
                    console.log('Adding new media:', formData);
                    
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify({ action: 'addMedia', data: formData })
                    });
                    
                    console.log('Add response status:', response.status);
                    const responseText = await response.text();
                    console.log('Add response text:', responseText);
                    
                    const result = JSON.parse(responseText);
                    
                    if (result.success) {
                        showMessage('เพิ่มสื่อการสอนใหม่เรียบร้อยแล้ว', 'success');
                        closeModal(); // ปิด modal ก่อน
                        await loadData();
                    } else {
                        showMessage('เกิดข้อผิดพลาด: ' + result.error, 'error');
                    }
                }
            } catch (error) {
                console.error('Error in handleSubmit:', error);
                showMessage('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + error.message, 'error');
            }
        }

        async function deleteMedia(id) {
            if (confirm('คุณต้องการลบสื่อนี้หรือไม่?')) {
                try {
                    showMessage('กำลังลบข้อมูล...', 'info');
                    console.log('🗑️ Deleting media with ID:', id);
                    
                    // ถ้าเป็นข้อมูลทดสอบ ให้ลบจาก array โดยตรง
                    if (id.startsWith('TEST')) {
                        console.log('🧪 Deleting test data locally');
                        const originalLength = mediaData.length;
                        mediaData = mediaData.filter(media => media.id !== id);
                        
                        if (mediaData.length < originalLength) {
                            console.log('✅ Test data deleted successfully');
                            showMessage('ลบสื่อเรียบร้อยแล้ว', 'success');
                            renderTable(); // อัพเดทตารางทันที
                        } else {
                            console.log('❌ Test data not found');
                            showMessage('ไม่พบข้อมูลที่ต้องการลบ', 'error');
                        }
                        return;
                    }
                    
                    // สำหรับข้อมูลจริงจาก Google Sheets
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify({ action: 'deleteMedia', id: id })
                    });
                    
                    console.log('Delete response status:', response.status);
                    const responseText = await response.text();
                    console.log('Delete response text:', responseText);
                    
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('JSON parse error in delete:', parseError);
                        showMessage('ข้อมูลตอบกลับไม่ถูกต้อง', 'error');
                        return;
                    }
                    
                    if (result.success) {
                        showMessage('ลบสื่อเรียบร้อยแล้ว', 'success');
                        await loadData();
                    } else {
                        showMessage('เกิดข้อผิดพลาด: ' + (result.error || 'ไม่ทราบสาเหตุ'), 'error');
                    }
                } catch (error) {
                    console.error('Error in deleteMedia:', error);
                    showMessage('เกิดข้อผิดพลาดในการลบข้อมูล: ' + error.message, 'error');
                }
            }
        }

        // ฟังก์ชันจัดการคลิกปุ่มลบ
        function handleDeleteClick(event) {
            const id = event.target.getAttribute('data-id');
            console.log('🗑️ Delete button clicked for ID:', id);
            
            // เปิด modal ยืนยันการลบแทนการใช้ confirm
            openDeleteModal(id);
        }

        // เพิ่มฟังก์ชันช่วยเหลือสำหรับ global access
        window.openEditModal = openEditModal;
        window.openDeleteModal = openDeleteModal;

        function filterData() {
            console.log('🔍 filterData() เริ่มทำงาน');
            
            // ตรวจสอบว่ามีข้อมูลหรือไม่
            if (!mediaData || mediaData.length === 0) {
                console.log('❌ ไม่มีข้อมูลให้กรอง');
                updateDebugInfo('ไม่มีข้อมูลให้ค้นหา');
                renderTable([]);
                return;
            }

            // ดึงค่าจากช่องค้นหา - ตรวจสอบให้แน่ใจว่า element มีอยู่
            let searchValue = '';
            let subjectValue = '';
            let gradeValue = '';
            let typeValue = '';

            try {
                searchValue = document.getElementById('searchInput').value || '';
                subjectValue = document.getElementById('subjectFilter').value || '';
                gradeValue = document.getElementById('gradeFilter').value || '';
                typeValue = document.getElementById('typeFilter').value || '';
            } catch (error) {
                console.error('Error getting filter values:', error);
                return;
            }

            const search = searchValue.toLowerCase().trim();
            const subject = subjectValue.toLowerCase().trim();
            const grade = gradeValue.trim();
            const type = typeValue.trim();

            console.log('🔍 เงื่อนไขการค้นหา:', { 
                search: `"${search}"`, 
                subject: `"${subject}"`, 
                grade: `"${grade}"`, 
                type: `"${type}"` 
            });

            // กรองข้อมูล
            const filtered = mediaData.filter(media => {
                if (!media) {
                    console.log('❌ Media object is null/undefined');
                    return false;
                }

                // ตรวจสอบชื่อสื่อ - เพิ่มการตรวจสอบที่ละเอียดขึ้น
                let titleMatch = true;
                if (search !== '') {
                    const mediaTitle = media.title ? media.title.toString().toLowerCase() : '';
                    titleMatch = mediaTitle.includes(search);
                    console.log(`🔍 Title check: "${mediaTitle}" includes "${search}" = ${titleMatch}`);
                }
                
                // ตรวจสอบวิชา - เพิ่มการตรวจสอบที่ละเอียดขึ้น
                let subjectMatch = true;
                if (subject !== '') {
                    const mediaSubject = media.subject ? media.subject.toString().toLowerCase() : '';
                    subjectMatch = mediaSubject.includes(subject);
                    console.log(`🔍 Subject check: "${mediaSubject}" includes "${subject}" = ${subjectMatch}`);
                }
                
                // ตรวจสอบระดับชั้น
                let gradeMatch = true;
                if (grade !== '') {
                    const mediaGrade = media.grade ? media.grade.toString() : '';
                    gradeMatch = mediaGrade === grade;
                    console.log(`🔍 Grade check: "${mediaGrade}" === "${grade}" = ${gradeMatch}`);
                }
                
                // ตรวจสอบประเภทสื่อ
                let typeMatch = true;
                if (type !== '') {
                    const mediaType = media.type ? media.type.toString() : '';
                    typeMatch = mediaType === type;
                    console.log(`🔍 Type check: "${mediaType}" === "${type}" = ${typeMatch}`);
                }

                const matchResult = titleMatch && subjectMatch && gradeMatch && typeMatch;
                
                // แสดงผลการตรวจสอบในกรณีที่มีการค้นหา
                if (search !== '' || subject !== '' || grade !== '' || type !== '') {
                    console.log(`📋 ${media.title || 'No title'}: title=${titleMatch}, subject=${subjectMatch}, grade=${gradeMatch}, type=${typeMatch} → ${matchResult}`);
                }
                
                return matchResult;
            });

            console.log(`✅ ผลการกรอง: ${filtered.length} จาก ${mediaData.length} รายการ`);
            
            // อัพเดท debug info
            if (search !== '' || subject !== '' || grade !== '' || type !== '') {
                updateDebugInfo(`พบ ${filtered.length} รายการจาก ${mediaData.length} รายการทั้งหมด`);
            }
            
            // แสดงผลในตาราง
            renderTable(filtered);
        }

        function renderTable(data = mediaData) {
            console.log('🎨 Rendering table with', data.length, 'items');
            totalCount.textContent = data.length;
            
            if (data.length === 0) {
                mediaTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p class="text-lg font-medium">ไม่พบข้อมูลสื่อการสอน</p>
                            <p class="text-sm">ลองเปลี่ยนเงื่อนไขการค้นหาหรือเพิ่มสื่อใหม่</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // เคลียร์ event listeners เก่า
            const oldDeleteBtns = mediaTableBody.querySelectorAll('.delete-btn');
            oldDeleteBtns.forEach(btn => {
                btn.removeEventListener('click', handleDeleteClick);
            });

            mediaTableBody.innerHTML = data.map(media => `
                <tr class="hover:bg-gray-50 transition-colors duration-150">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${media.id || 'N/A'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${media.date ? new Date(media.date).toLocaleDateString('th-TH') : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            ${media.subject || 'N/A'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            ${media.grade || 'N/A'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getTypeColor(media.type)}">
                            ${media.type || 'N/A'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">${media.title || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        ${media.mediaLink ? `
                            <a href="${media.mediaLink}" target="_blank" class="text-blue-600 hover:text-blue-900 transition-colors duration-150" title="เปิดสื่อ">
                                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                        ` : ''}
                        ${media.editLink ? `
                            <a href="${media.editLink}" target="_blank" class="text-green-600 hover:text-green-900 transition-colors duration-150" title="แก้ไขสื่อ">
                                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </a>
                        ` : ''}
                        <button onclick="openEditModal('${media.id}')" class="text-yellow-600 hover:text-yellow-900 transition-colors duration-150" title="แก้ไขข้อมูล">
                            <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button class="delete-btn text-red-600 hover:text-red-900 transition-colors duration-150" data-id="${media.id}" title="ลบข้อมูล">
                            🗑️
                        </button>
                    </td>
                </tr>
            `).join('');

            // เพิ่ม event listeners ใหม่หลังจากสร้างตาราง
            const deleteButtons = mediaTableBody.querySelectorAll('.delete-btn');
            deleteButtons.forEach(btn => {
                btn.addEventListener('click', handleDeleteClick);
            });
        }

        function getTypeColor(type) {
            const colors = {
                'วิดีโอ': 'bg-red-100 text-red-800',
                'เอกสาร': 'bg-blue-100 text-blue-800',
                'รูปภาพ': 'bg-yellow-100 text-yellow-800',
                'เสียง': 'bg-pink-100 text-pink-800',
                'เกม': 'bg-indigo-100 text-indigo-800',
                'แบบทดสอบ': 'bg-gray-100 text-gray-800',
                'เว็บไซต์': 'bg-teal-100 text-teal-800',
                'มัลติมีเดีย': 'bg-orange-100 text-orange-800'
            };
            return colors[type] || 'bg-gray-100 text-gray-800';
        }

        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            let bgColor = 'bg-green-500 text-white';
            
            if (type === 'error') {
                bgColor = 'bg-red-500 text-white';
            } else if (type === 'info') {
                bgColor = 'bg-blue-500 text-white';
            }
            
            messageDiv.className = `p-4 rounded-lg shadow-lg mb-4 transition-all duration-300 ${bgColor}`;
            messageDiv.textContent = message;
            
            document.getElementById('messageContainer').appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateX(100%)';
                setTimeout(() => messageDiv.remove(), 300);
            }, 3000);
        }

        // เพิ่มข้อมูลทดสอบเพื่อทดสอบระบบค้นหา
        function addTestData() {
            mediaData = [
                {
                    id: 'TEST001',
                    date: '2024-01-15',
                    subject: 'คณิตศาสตร์',
                    grade: 'ม.1',
                    type: 'วิดีโอ',
                    title: 'สมการเชิงเส้นตัวแปรเดียว',
                    mediaLink: 'https://example.com/math1',
                    editLink: 'https://example.com/edit1'
                },
                {
                    id: 'TEST002',
                    date: '2024-01-16',
                    subject: 'ฟิสิกส์',
                    grade: 'ม.4',
                    type: 'เอกสาร',
                    title: 'กฎของนิวตัน',
                    mediaLink: 'https://example.com/physics1',
                    editLink: ''
                },
                {
                    id: 'TEST003',
                    date: '2024-01-17',
                    subject: 'เคมี',
                    grade: 'ม.5',
                    type: 'รูปภาพ',
                    title: 'ตารางธาตุ',
                    mediaLink: 'https://example.com/chemistry1',
                    editLink: 'https://example.com/edit3'
                },
                {
                    id: 'TEST004',
                    date: '2024-01-18',
                    subject: 'คณิตศาสตร์',
                    grade: 'ม.3',
                    type: 'เกม',
                    title: 'เกมคูณหาร',
                    mediaLink: 'https://example.com/mathgame',
                    editLink: ''
                }
            ];
            
            console.log('📊 เพิ่มข้อมูลทดสอบ:', mediaData.length, 'รายการ');
            renderTable();
            showMessage('เพิ่มข้อมูลทดสอบเรียบร้อย (4 รายการ)', 'info');
        }

        // Initialize
        console.log('🚀 Initializing application...');
        
        // ลองโหลดข้อมูลจริงก่อน หากไม่ได้ให้ใช้ข้อมูลทดสอบ
        loadData().catch(() => {
            console.log('⚠️ ไม่สามารถโหลดข้อมูลจริงได้ ใช้ข้อมูลทดสอบแทน');
            addTestData();
        });
        
        // เพิ่มปุ่มสำหรับเพิ่มข้อมูลทดสอบ
        const testButton = document.createElement('button');
        testButton.textContent = 'เพิ่มข้อมูลทดสอบ';
        testButton.className = 'ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm';
        testButton.onclick = addTestData;
        addMediaBtn.parentNode.appendChild(testButton);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'977bc9a5905e5805',t:'MTc1NjYzNTU0Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
